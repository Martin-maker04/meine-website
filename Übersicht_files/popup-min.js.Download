

/* global yii, $ */

// The global variable holding the dialog
let bpopup = null;

/**
 * Attaches the dialog to the body
 * @returns {undefined}
 */
function attachDialog() {
    $('.yesnodialog_container').remove();
    if ($('.yesnodialog_container').length === 0) {
        const html =
            '<div class="yesnodialog_container">' +
            '<div class="yesnodialog_title">Bestätigung<div class="yesnodialog_closebutton"><i id="yesnodialog_close" style="line-height:30px" class="fa fa-times"></i></div></div>' +
            '<div class="yesnodialog_content">Es wurden Daten geändert. Sollen diese gespeichert werden?</div>' +
            '<div class="yesnodialog_buttonbar">' +
            '<div id="yesnodialog_buttons">' +
            '<button type="button" class="yesnodialog_button btn pullright" id="yesnodialog_Cancel">Nein</button>' +
            '<button type="button" style="float:right" class="yesnodialog_button btn" id="yesnodialog_OK">Ja</button>' +
            '</div>' +
            '</div>' +
            '</div>';

        $('body').append(html);
    }
}

/**
 * Closes the popup
 */
function closePopup() {
    bpopup.close();
}

/**
 * Shows a dialog
 * @param text
 * @param onOk function if ok was clicked
 * @param onNok function if not ok was clicked
 * @param title
 * @param textOk
 * @param textNok
 * @returns void
 */
function showPopup(text, onOk, onNok, title, textOk, textNok) {
    attachDialog();

    if (typeof title !== 'undefined') {
        $('.yesnodialog_title').html(title);
    }
    if (typeof textOk !== 'undefined') {
        if (textOk == '') {
            $('#yesnodialog_OK').css('display','none');
        } else {
            $('#yesnodialog_OK').html(textOk);
        }
    }
    if (typeof textNok !== 'undefined') {
        if (textNok == '') {
            $('#yesnodialog_Cancel').css('display','none');
        } else {
            $('#yesnodialog_Cancel').html(textNok);
        }
    }


    $('#yesnodialog_OK').off('click');
    $('#yesnodialog_Cancel').off('click');
    $('#yesnodialog_close').off('click');


    $('#yesnodialog_OK').on('click',typeof onOk === 'undefined'?closePopup:onOk);
    $('#yesnodialog_Cancel').on('click',typeof onNok === 'undefined'?closePopup:onNok);
    $('#yesnodialog_close').on('click',typeof onNok === 'undefined'?closePopup:onNok);
    $('.yesnodialog_content').html(text);

    bpopup = $('.yesnodialog_container').bPopup({
        modalClose: false,
        opacity: 0.6,
        positionStyle: 'absolute' //'fixed' or 'absolute'
    });
}




function showPflanzenInfo(pflanze) {
    $('#pflanzenInfoPopOver').bPopup({
        modalClose: false,
        opacity: 0.6,
        positionStyle: 'absolute', //'fixed' or 'absolute',
        onOpen: function() {
            $('#pflanzenInfoPopOver .popover-header').html(pflanze.deutscher_name + '<div class="b-close">X</div>');
            $('#pflanzenInfoPopOver .popover-content img').attr('src', pflanze.link_bild);
            $('#pflanzenInfoPopOver .popover-content img').attr('title', pflanze.bild_quelle);
            $('#pflanzenInfoPopOver .popover-content h4').html(pflanze.taxon_name);
            $('#pflanzenInfoPopOver .popover-content small').html('Genauigkeit 33%');
            $('#pflanzenInfoPopOver .popover-content .pflanze-beschreibung').html(pflanze.beschreibung);
            $('#pflanzenInfoPopOver .popover-content .pflanze-weitere-info a').attr('src', pflanze.link_quelle);
            $('#pflanzenInfoPopOver .popover-content .pflanze-weitere-info a').html(pflanze.link_quelle);

            const link = $('#pflanzenInfoPopOver .popover-content .pflanze-delete').attr('data-link');
            $('#pflanzenInfoPopOver .popover-content .pflanze-delete').attr('href', link.replace('%5BID%5D', pflanze.id));
        },
    });
}

function showPremiumPopup(html, aktion) {

    function gotoPremium() {
        const add = ((aktion === null || typeof (aktion) === 'undefined') ? '' : '?aktion=' + aktion);
        location.href ='/premium/create'+add;
    }

    if (typeof html==='undefined' || html===null) {
        html='<p>Erweitern Sie Ihre Mitgliedschaft.</p>';
    }


    const text = '<div style="margin-bottom: 60px;" class="col-lg-12 text-center">' +
        '<img class="img-responsive" style="margin-bottom: -15px; width:100px; display:block; margin-left :auto; margin-right :auto;" src="/img/crown_yellow.svg" alt="Premium">' +
        '<h1>Mitgliedschaft erweitern</h1>' +
        '<h4>Organisieren Sie noch mehr Stände und Völker.</h4>' +
        html;
    showPopup(text, gotoPremium, closePopup, 'Erweiterung', 'Ja','Nein danke!' );

}

function showNoWerbungPopup(html, aktion) {

    function gotoPremium() {
        const add = ((aktion === null || typeof (aktion) === 'undefined') ? '' : '?aktion=' + aktion);
        location.href ='/premium/create'+add;
    }

    if (typeof html==='undefined' || html===null) {
        html='<p>Erweitern Sie Ihre Mitgliedschaft.</p>';
    }


    const text = '<div style="margin-bottom: 60px;" class="col-lg-12 text-center">' +
        '<h1>Keine <br> Lust mehr auf <br> Werbung?</h1>' +
        '<img class="img-responsive" style="margin-bottom: -15px; width:100px; display:block; margin-left :auto; margin-right :auto;margin-bottom :auto;" src="/img/beequote.svg" alt="Premium">' +
        '<h4>... und diesen Dialog.</h4>' +
        '<h5>Mit dem kauf einer BeeInTouch-Erweiterung wird Ihnen keine Werbung mehr eingeblendet.</h5>' +
        html;
    showPopup(text, gotoPremium, closePopup, 'BeeInTouch - Erweiterung', 'Ja','Nein danke!' );

}

yii.confirm = function (message, ok, cancel) {

    function onOk() {
        !ok||ok();
        closePopup();
    }

    function onCancel() {
        !cancel || cancel();
        closePopup();
    }

    showPopup(message, onOk, onCancel, 'Bestätigung');
//            yii.handleAction($e);
    // confirm will always return false on the first call
    // to cancel click handler
    return false;
};